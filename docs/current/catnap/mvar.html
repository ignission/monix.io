<!DOCTYPE html>
<html lang="en-us">

  <head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  
  <title>MVar &mdash; Monix</title>

  <link rel="canonical" href="https://monix.io/docs/current/catnap/mvar.html" />

  <!-- Twitter Cards -->
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:image:src" content="https://monix.io/public/images/monix-logo-rect.png">
  <meta name="twitter:site" content="@monix" />  
  <meta name="twitter:creator" content="@monix" />  
  <meta name="twitter:title" content="MVar &amp;mdash; Monix" />
  <meta name="twitter:description" content="空または値を含めることができる可変の変数で、空のときは非同期に読み込みをブロックし、満杯のときは書き込みをブロックします。" />
  <meta name="twitter:url" content="https://monix.io/docs/current/catnap/mvar.html">
  <!-- Facebook Open-Graph -->
  <meta property="fb:app_id" content="2160100887367418" />

  <meta content="Monix" property="og:site_name">
  <meta content="MVar &amp;mdash; Monix" property="og:title">
  <meta content="空または値を含めることができる可変の変数で、空のときは非同期に読み込みをブロックし、満杯のときは書き込みをブロックします。" property="og:description">
  <meta content="https://monix.io/docs/current/catnap/mvar.html" property="og:url">
  <meta content="2021-07-08T14:19:40+00:00" property="article:modified_time">
    
  <meta content="article" property="og:type">
  <meta property="og:image" content="https://monix.io/public/images/monix-logo.png" />
  <meta property="og:image:secure_url" content="https://monix.io/public/images/monix-logo.png" />
  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/all.css?1625754182468065957">
  <!--[if lt IE 9]>
  <link rel="stylesheet" href="/public/css/forkme.ie.css?1625754182468065957">
  <![endif]-->

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Web App Manifest, see: http://manifest.sysapps.org/ -->
  <link rel="manifest" href="/manifest.json">
  <!-- Icons -->
  <link rel="icon" sizes="48x48" href="/public/icons/icon-48x48.png">
  <link rel="icon" sizes="72x72" href="/public/icons/icon-72x72.png">
  <link rel="icon" sizes="96x96" href="/public/icons/icon-96x96.png">
  <link rel="icon" sizes="144x144" href="/public/icons/icon-144x144.png">
  <link rel="icon" sizes="192x192" href="/public/icons/icon-192x192.png">
  <link rel="icon" sizes="240x240" href="/public/icons/icon-240x240.png">
  <link rel="icon" sizes="384x384" href="/public/icons/icon-384x384.png">
  <!-- Mobile Safari / iOS Icons -->
  <link rel="apple-touch-icon" sizes="48x48" href="/public/icons/icon-48x48.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/public/icons/icon-72x72.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/public/icons/icon-96x96.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/public/icons/icon-144x144.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/public/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="240x240" href="/public/icons/icon-240x240.png">
  <link rel="apple-touch-icon" sizes="384x384" href="/public/icons/icon-384x384.png">
  <!-- Standard Favicon -->
  <link rel="shortcut icon" href="/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="Feed" href="/blog/atom.xml">
</head>


  <body class="monix layout">
    <div class="wrapper">
      <aside class="sidebar plus">
  <div class="container">
    <div class="sidebar-about">
      <a class="github-fork-ribbon left-top" href="https://github.com/monix/monix"
        title="Fork me on GitHub">Fork me on GitHub</a>

      <h1>
        <a href="/">
          <img src="/public/images/monix-logo.png"
            alt="Monix Logo" title="Monix" class="logo" />
        </a>
      </h1>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">About</a>
      <a class="sidebar-nav-item" href="/blog/">Blog</a>
      <a class="sidebar-nav-item active" href="/docs/current/">Documentation</a>
      <a class="sidebar-nav-item" href="/presentations/">Presentations</a>
      <a class="sidebar-nav-item" href="/social.html">Follow @Monix</a>
      <a class="sidebar-nav-item" href="/privacy.html">Privacy Policy</a>
    </nav>
  </div>
</aside>


      <article class="content container">
        <div class="page">
      <h1 class="page-title">
        
        
          MVar
        
        
      </h1>

  
  <time class="post-date" itemprop="dateModified"
    datetime="2021-07-08">
    <b>ページの更新日:</b> 08 Jul 2021
  </time>
  <nav role="navigation" id="type-info">
    <a href="/api/current/monix/catnap/MVar.html">APIドキュメント</a>
    <a href="https://github.com/monix/monix/blob/v3.4.0/monix-catnap/shared/src/main/scala/monix/catnap/MVar.scala">ソースコード</a>
    
    <a href="https://github.com/monix/monix.io/blob/master/_docs/3x/catnap/mvar.md">ページを編集</a>
    
  </nav>
  
  <div id="version3x">
    最新のMonix 3.xシリーズのドキュメントが表示されています。<br/>
    古いバージョン:
    
      <a href="/docs/2x/">2.x</a>
  </div>

  <nav role="navigation" id="toc">
    <ul>
  <li><a href="#概要">概要</a>
    <ul>
      <li><a href="#インスピレーション">インスピレーション</a></li>
    </ul>
  </li>
  <li><a href="#cats-effect">Cats-Effect</a></li>
  <li><a href="#ユースケース-同期した可変型変数">ユースケース: 同期した可変型変数</a></li>
  <li><a href="#ユースケース-非同期ロックバイナリセマフォミューテックス">ユースケース: 非同期ロック(バイナリセマフォ、ミューテックス)</a></li>
  <li><a href="#ユースケース-プロデューサーコンシューマーチャンネル">ユースケース: プロデューサー/コンシューマーチャンネル</a></li>
</ul>

  </nav>

  <p><code class="language-plaintext highlighter-rouge">MVar</code>は、空または値を含めることができる可変の変数で、空のときは非同期に読み込みをブロックし、満杯のときは書き込みをブロックします。</p>
    
      <h2 id="概要">
        
        
          概要 <a href="#概要" class="anchor">#</a>
        
        
      </h2>

<p>ユースケース:</p>

<ol>
  <li>同期され、スレッドセーフな可変型変数として</li>
  <li><code class="language-plaintext highlighter-rouge">take</code>と<code class="language-plaintext highlighter-rouge">put</code>が「受信」と「送信」の役割を持つチャンネルとして</li>
  <li><code class="language-plaintext highlighter-rouge">take</code>と<code class="language-plaintext highlighter-rouge">put</code>が「取得」と「解放」の役割を持つバイナリーセマフォとして</li>
</ol>

<p>これらの基本的でアトミックな操作を持っています:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">put</code>は空の場合に変数へ値を入れるか、変数が再び空になるまで(非同期に)ブロックする。</li>
  <li><code class="language-plaintext highlighter-rouge">tryPut</code>は空の場合に変数へ値を入れようとし、成功した場合は<code class="language-plaintext highlighter-rouge">true</code>を返す。</li>
  <li><code class="language-plaintext highlighter-rouge">take</code>は満杯になったときにvarを空にして含まれている値を返し、そうでなければ取り出す値があるまで(非同期に)ブロックする。</li>
  <li><code class="language-plaintext highlighter-rouge">tryTake</code>は満杯になったら空にし、<code class="language-plaintext highlighter-rouge">None</code>を返す。</li>
  <li><code class="language-plaintext highlighter-rouge">read</code>は現在の値があると仮定して触れずに読み取るか、そうでなければ<code class="language-plaintext highlighter-rouge">put</code>で値が利用可能になるまで待つ。</li>
  <li><code class="language-plaintext highlighter-rouge">tryRead</code>は満杯であれば<code class="language-plaintext highlighter-rouge">Some(a)</code>を変更せずに返し、そうでなければ <code class="language-plaintext highlighter-rouge">None</code> を返す。</li>
  <li><code class="language-plaintext highlighter-rouge">isEmpty</code>は現在空であれば<code class="language-plaintext highlighter-rouge">true</code>を返す。</li>
</ul>

<p class="extra">
この文脈では、”<i>非同期ブロッキング</i>“とはスレッドをブロックしないことを意味します。
その代わりに実装では、操作が終了したことをクライアントに通知するためにコールバックを使用しています(通知方法は<a href="./task.md">Task</a>によって公開されています)。
そのため、Javascriptの上でも動作します。
</p>
    
      <h3 id="インスピレーション">
        
        
          インスピレーション <a href="#インスピレーション" class="anchor">#</a>
        
        
      </h3>

<p>このデータタイプは、論文<a href="http://research.microsoft.com/~simonpj/papers/concurrent-haskell.ps.gz">Concurrent Haskell</a>で紹介されています。
Simon Peyton Jones、Andrew Gordon、Sigbjorn Finneによって実装の詳細は変更されています(特に完全な<code class="language-plaintext highlighter-rouge">MVar</code>への<code class="language-plaintext highlighter-rouge">put</code>は以前はエラーになっていましたが、現在は単にブロックするだけです)。</p>

<p>同期プリミティブの構築や単純なスレッド間通信の実行に適しています。
これは<code class="language-plaintext highlighter-rouge">BlockingQueue(capacity = 1)</code>と同等のものです。
ただし、実際にはスレッドのブロッキングは行われず、<code class="language-plaintext highlighter-rouge">Task</code>を利用することになります。</p>
    
      <h2 id="cats-effect">
        
        
          Cats-Effect <a href="#cats-effect" class="anchor">#</a>
        
        
      </h2>

<p><code class="language-plaintext highlighter-rouge">MVar</code>は汎用的で、<a href="https://typelevel.org/cats-effect/">Cats-Effect</a>の型クラスを介してエフェクトタイプを抽象化するように作られています。
つまり、Monixの<code class="language-plaintext highlighter-rouge">Task</code>と同じように<code class="language-plaintext highlighter-rouge">MVar</code>を<a href="https://typelevel.org/cats-effect/datatypes/io.html">cats.effect.IO</a>や、<code class="language-plaintext highlighter-rouge">Async</code>、<code class="language-plaintext highlighter-rouge">Concurrent</code>を実装したデータタイプと同様に使用できるということです。</p>

<p>なお、<code class="language-plaintext highlighter-rouge">MVar</code>については<a href="https://typelevel.org/cats-effect/concurrency/mvar.md">cats.effect.concurrent.MVar</a>ですでに説明されており、Monixは実際にそのインターフェイスを実装しています。</p>

<p><a href="https://typelevel.org/cats-effect/concurrency/mvar.md" target="_blank" title="cats.effect.concurrent.MVar" alt="cats.effect.concurrent.MVar">
  <img src="https://monix.io/public/images/concurrency-mvar.png" width="400" />
</a></p>

<p>次の理由から、<code class="language-plaintext highlighter-rouge">MVar</code>はMonixにも残ります:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Future</code>に対応した代替品として、<a href="/api/current/monix/execution/AsyncVar.html">monix.execution.AsyncVar</a>と実装を共有している。</li>
  <li>Monixの<a href="/docs/current/execution/atomic.html">Atomic</a>の実装を使うことができる。</li>
  <li>現時点でMonixの<code class="language-plaintext highlighter-rouge">MVar</code>には、次のバージョンの<code class="language-plaintext highlighter-rouge">Cats-Effect</code>が上流にマージされるのを待つ必要がある。</li>
</ol>
    
      <h2 id="ユースケース-同期した可変型変数">
        
        
          ユースケース: 同期した可変型変数 <a href="#ユースケース-同期した可変型変数" class="anchor">#</a>
        
        
      </h2>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">monix.execution.CancelableFuture</span>
<span class="k">import</span> <span class="nn">monix.catnap.MVar</span>
<span class="k">import</span> <span class="nn">monix.eval.Task</span>

<span class="k">def</span> <span class="nf">sum</span><span class="o">(</span><span class="n">state</span><span class="k">:</span> <span class="kt">MVar</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">],</span> <span class="n">list</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">list</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Nil</span> <span class="k">=&gt;</span> <span class="nv">state</span><span class="o">.</span><span class="py">take</span>
    <span class="k">case</span> <span class="n">x</span> <span class="o">::</span> <span class="n">xs</span> <span class="k">=&gt;</span>
      <span class="nv">state</span><span class="o">.</span><span class="py">take</span><span class="o">.</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">current</span> <span class="k">=&gt;</span>
        <span class="nv">state</span><span class="o">.</span><span class="py">put</span><span class="o">(</span><span class="n">current</span> <span class="o">+</span> <span class="n">x</span><span class="o">).</span><span class="py">flatMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nf">sum</span><span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">xs</span><span class="o">))</span>
      <span class="o">}</span>
  <span class="o">}</span>

<span class="k">val</span> <span class="nv">task</span> <span class="k">=</span> 
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">state</span> <span class="k">&lt;-</span> <span class="nc">MVar</span><span class="o">[</span><span class="kt">Task</span><span class="o">].</span><span class="py">of</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
    <span class="n">r</span> <span class="k">&lt;-</span> <span class="nf">sum</span><span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="o">(</span><span class="mi">0</span> <span class="n">until</span> <span class="mi">100</span><span class="o">).</span><span class="py">toList</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">r</span>

<span class="c1">// 評価する</span>
<span class="nv">task</span><span class="o">.</span><span class="py">runToFuture</span><span class="o">.</span><span class="py">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
<span class="c1">//=&gt; 4950</span>
</code></pre></div></div>

<p>このサンプルは<code class="language-plaintext highlighter-rouge">MVar</code>がどのように変数として使用できるかを示す以外、あまり役に立ちません。
<code class="language-plaintext highlighter-rouge">take</code>と<code class="language-plaintext highlighter-rouge">put</code>の操作はアトミックです。
利用可能な値がない場合、<code class="language-plaintext highlighter-rouge">take</code>の呼び出しは(非同期的に)ブロックします。
一方、<code class="language-plaintext highlighter-rouge">put</code>の呼び出しは<code class="language-plaintext highlighter-rouge">MVar</code>にすでに値が入っていて，その値が返されるのを待っている場合にブロックします。</p>

<p>明らかに、<code class="language-plaintext highlighter-rouge">take</code>の呼び出しの後<code class="language-plaintext highlighter-rouge">put</code>の呼び出しの前には、同じ変数を更新できる同時実行のロジックがあります。
2つの操作は単独ではアトミックですが、組み合わせる操作はアトミックではありません(つまりアトミックな操作は合成されません)。
このサンプルを<em>安全</em>にしたいのであれば、追加の同期が必要になります。</p>
    
      <h2 id="ユースケース-非同期ロックバイナリセマフォミューテックス">
        
        
          ユースケース: 非同期ロック(バイナリセマフォ、ミューテックス) <a href="#ユースケース-非同期ロックバイナリセマフォミューテックス" class="anchor">#</a>
        
        
      </h2>

<p><code class="language-plaintext highlighter-rouge">take</code>操作は「取得」、<code class="language-plaintext highlighter-rouge">put</code>操作は「解除」の役割を果たします。
それではやってみましょう。</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">final</span> <span class="k">class</span> <span class="nc">MLock</span><span class="o">(</span><span class="n">mvar</span><span class="k">:</span> <span class="kt">MVar</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Unit</span><span class="o">])</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">acquire</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">mvar</span><span class="o">.</span><span class="py">take</span>

  <span class="k">def</span> <span class="nf">release</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">mvar</span><span class="o">.</span><span class="py">put</span><span class="o">(())</span>

  <span class="k">def</span> <span class="nf">greenLight</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">fa</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">acquire</span>
      <span class="n">a</span> <span class="k">&lt;-</span> <span class="nv">fa</span><span class="o">.</span><span class="py">doOnCancel</span><span class="o">(</span><span class="n">release</span><span class="o">)</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">release</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">a</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">MLock</span> <span class="o">{</span>
  <span class="cm">/** ビルダー */</span>
  <span class="k">def</span> <span class="nf">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">MLock</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">MVar</span><span class="o">[</span><span class="kt">Task</span><span class="o">].</span><span class="py">of</span><span class="o">(()).</span><span class="py">map</span><span class="o">(</span><span class="n">v</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">MLock</span><span class="o">(</span><span class="n">v</span><span class="o">))</span>
<span class="o">}</span>
</code></pre></div></div>

<p>そして今度は、先ほどの例に同期を適用してみましょう:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">task</span> <span class="k">=</span> 
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">lock</span> <span class="k">&lt;-</span> <span class="nc">MLock</span><span class="o">()</span>
    <span class="n">state</span> <span class="k">&lt;-</span> <span class="nc">MVar</span><span class="o">[</span><span class="kt">Task</span><span class="o">].</span><span class="py">of</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
    <span class="n">task</span> <span class="k">=</span> <span class="nf">sum</span><span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="o">(</span><span class="mi">0</span> <span class="n">until</span> <span class="mi">100</span><span class="o">).</span><span class="py">toList</span><span class="o">)</span>
    <span class="n">r</span> <span class="k">&lt;-</span> <span class="nv">lock</span><span class="o">.</span><span class="py">greenLight</span><span class="o">(</span><span class="n">task</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">r</span>

<span class="c1">// 評価する</span>
<span class="nv">task</span><span class="o">.</span><span class="py">runToFuture</span><span class="o">.</span><span class="py">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
<span class="c1">//=&gt; 4950</span>
</code></pre></div></div>
    
      <h2 id="ユースケース-プロデューサーコンシューマーチャンネル">
        
        
          ユースケース: プロデューサー/コンシューマーチャンネル <a href="#ユースケース-プロデューサーコンシューマーチャンネル" class="anchor">#</a>
        
        
      </h2>

<p>明白な使用例は、単純なプロデューサーとコンシューマーのチャンネルをモデル化することです。</p>

<p>イベントをプッシュする必要のあるプロデューサーがいるとします。
しかし、バックプレッシャーも必要なので、新しいイベントを生成する前にコンシューマが最後のイベントを消費するのを待つ必要があります。</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 完了を検知する必要があるためのシグナリングオプション</span>
<span class="k">type</span> <span class="kt">Channel</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">MVar</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span>

<span class="k">def</span> <span class="nf">producer</span><span class="o">(</span><span class="n">ch</span><span class="k">:</span> <span class="kt">Channel</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span> <span class="n">list</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">list</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Nil</span> <span class="k">=&gt;</span>
      <span class="nv">ch</span><span class="o">.</span><span class="py">put</span><span class="o">(</span><span class="nc">None</span><span class="o">)</span> <span class="c1">// できた！</span>
    <span class="k">case</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span> <span class="k">=&gt;</span>
      <span class="c1">// 次、お願いします</span>
      <span class="nv">ch</span><span class="o">.</span><span class="py">put</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="n">head</span><span class="o">)).</span><span class="py">flatMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nf">producer</span><span class="o">(</span><span class="n">ch</span><span class="o">,</span> <span class="n">tail</span><span class="o">))</span>
  <span class="o">}</span>

<span class="k">def</span> <span class="nf">consumer</span><span class="o">(</span><span class="n">ch</span><span class="k">:</span> <span class="kt">Channel</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span> <span class="n">sum</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">ch</span><span class="o">.</span><span class="py">take</span><span class="o">.</span><span class="py">flatMap</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="c1">// 次、お願いします</span>
      <span class="nf">consumer</span><span class="o">(</span><span class="n">ch</span><span class="o">,</span> <span class="n">sum</span> <span class="o">+</span> <span class="n">x</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
      <span class="nv">Task</span><span class="o">.</span><span class="py">now</span><span class="o">(</span><span class="n">sum</span><span class="o">)</span> <span class="c1">// できた！</span>
  <span class="o">}</span>

<span class="k">val</span> <span class="nv">count</span> <span class="k">=</span> <span class="mi">100000</span>

<span class="k">val</span> <span class="nv">sumTask</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">channel</span> <span class="k">&lt;-</span> <span class="nc">MVar</span><span class="o">[</span><span class="kt">Task</span><span class="o">].</span><span class="py">empty</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]()</span>
    <span class="n">producerTask</span> <span class="k">=</span> <span class="nf">producer</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="o">(</span><span class="mi">0</span> <span class="n">until</span> <span class="n">count</span><span class="o">).</span><span class="py">toList</span><span class="o">).</span><span class="py">executeAsync</span>
    <span class="n">consumerTask</span> <span class="k">=</span> <span class="nf">consumer</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="mi">0L</span><span class="o">).</span><span class="py">executeAsync</span>
    <span class="c1">// 実際には必要ないが、念のために並列処理を確実に行う。</span>
    <span class="n">sum</span> <span class="k">&lt;-</span> <span class="nv">Task</span><span class="o">.</span><span class="py">parMap2</span><span class="o">(</span><span class="n">producerTask</span><span class="o">,</span> <span class="n">consumerTask</span><span class="o">)((</span><span class="k">_</span><span class="o">,</span><span class="n">sum</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">sum</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">sum</span>

<span class="c1">// 評価する</span>
<span class="nv">sumTask</span><span class="o">.</span><span class="py">runToFuture</span><span class="o">.</span><span class="py">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
<span class="c1">//=&gt; 4999950000</span>
</code></pre></div></div>

<p>これを実行すると期待通りに動作します。
<code class="language-plaintext highlighter-rouge">producer</code>が値を<code class="language-plaintext highlighter-rouge">MVar</code>にプッシュし、<code class="language-plaintext highlighter-rouge">consumer </code>がそれらの値をすべて消費します。</p>


  <div class="buttons">
    <a href="/docs/current/">Contents</a> •
    <a href="https://github.com/monix/monix.io/blob/master/_docs/3x/catnap/mvar.md">
      ページを編集</a> •
    
    <a href="https://gitter.im/monix/monix">
      チャットに参加</a> •
    <a href="/social.html">
      フォロー</a>
  </div>

  </div>
      </article>
    </div>
    <script type="text/javascript">
  var _paq = window._paq || [];
  // Disabling cookies for privacy reasons
  _paq.push(['disableCookies']);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https://ly.monix.io/";
    _paq.push(['setTrackerUrl', u+'m.php']);
    _paq.push(['setSiteId', '2']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'m.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript>
  
  <img src="https://ly.monix.io/m.php?idsite=2&rec=1&action_name=MVar" style="border:0" alt="" />
</noscript>


  </body>
</html>
